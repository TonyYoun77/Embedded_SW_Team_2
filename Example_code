import os
import time
import json
import subprocess
import cv2
import requests
import RPi.GPIO as GPIO
from ultralytics import YOLO

# ì„¼ì„œ í•€
PIR_PIN = 17

# ê¸°ë³¸ ê²½ë¡œ
RECORD_DIR = "/home/pi/security_project/recordings"
os.makedirs(RECORD_DIR, exist_ok=True)

# YOLOv8 ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸° (ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œë„ ê°€ëŠ¥)
model = YOLO('/home/pi/security_project/yolov8n.pt')  # nano ëª¨ë¸

# Seafile ì„¤ì •
SEAFILE_UPLOAD_URL = "https://your-seafile-server.com/upload-api-url"
SEAFILE_TOKEN = "your_token"

# GPIO ì„¤ì •
GPIO.setmode(GPIO.BCM)
GPIO.setup(PIR_PIN, GPIO.IN)

# ì¡°ë„ ì„¼ì„œ í•¨ìˆ˜ (ADC ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì˜ˆì‹œ)
def is_dark():
    return True  # ê°„ë‹¨í™”: ì‹¤ì œë¡œëŠ” ADC ì´ìš© í•„ìš”

# ì„¼ì„œ íŠ¸ë¦¬ê±°
def sensor_triggered():
    return GPIO.input(PIR_PIN) == GPIO.HIGH and is_dark()

# ë…¹í™”
def record_video(output_path, duration=10):
    command = [
        'ffmpeg',
        '-y',
        '-f', 'v4l2', '-framerate', '20', '-video_size', '640x480', '-i', '/dev/video0',
        '-f', 'alsa', '-i', 'plughw:1',
        '-c:v', 'libx264', '-preset', 'ultrafast',
        '-c:a', 'aac',
        '-t', str(duration),
        output_path
    ]
    subprocess.run(command, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

# YOLO ìœ„í—˜ ë¶„ì„
def detect_risk(video_path):
    cap = cv2.VideoCapture(video_path)
    risk_labels = ['knife', 'gun', 'fire']
    is_risk = False

    while True:
        ret, frame = cap.read()
        if not ret:
            break

        results = model(frame, verbose=False)
        names = results[0].names
        for r in results:
            for cls_id in r.boxes.cls:
                label = names[int(cls_id)]
                if label in risk_labels:
                    is_risk = True
                    print(f"ìœ„í—˜ ê°ì§€ë¨: {label}")
                    break
            if is_risk:
                break

        if is_risk:
            break
    cap.release()
    return is_risk

# Seafile ì—…ë¡œë“œ
def upload_to_seafile(file_path):
    headers = {'Authorization': f'Token {SEAFILE_TOKEN}'}
    files = {'file': open(file_path, 'rb')}
    data = {'parent_dir': '/'}
    response = requests.post(SEAFILE_UPLOAD_URL, headers=headers, data=data, files=files)
    return response.status_code == 200

# ë©”ì¸ ë£¨í”„
def main():
    print("âœ… ì‹œìŠ¤í…œ ì‹œì‘: ì„¼ì„œ ê°ì§€ ëŒ€ê¸° ì¤‘")
    while True:
        if sensor_triggered():
            timestamp = time.strftime('%Y-%m-%d_%H-%M-%S')
            folder = os.path.join(RECORD_DIR, timestamp)
            os.makedirs(folder, exist_ok=True)

            video_path = os.path.join(folder, "video.mp4")
            flag_path = os.path.join(folder, "flag.json")

            print("ğŸ¬ ë…¹í™” ì‹œì‘")
            record_video(video_path)

            print("ğŸ” YOLOv8 ë¶„ì„ ì¤‘")
            risk = detect_risk(video_path)

            if risk:
                with open(flag_path, 'w') as f:
                    json.dump({"risk": True, "time": timestamp}, f)
                print("âš ï¸ ìœ„í—˜ í”Œë˜ê·¸ ì €ì¥ ì™„ë£Œ")

            print("â˜ï¸ Seafile ì—…ë¡œë“œ ì¤‘")
            upload_to_seafile(video_path)
            if risk:
                upload_to_seafile(flag_path)

            print("âœ… ì²˜ë¦¬ ì™„ë£Œ. ì„¼ì„œ ëŒ€ê¸° ì¤‘...\n")
            time.sleep(3)
        else:
            time.sleep(1)

# í”„ë¡œê·¸ë¨ ì§„ì…ì 
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        GPIO.cleanup()
        print("\nğŸ›‘ í”„ë¡œê·¸ë¨ ì¢…ë£Œë¨.")
