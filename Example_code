import os
import time
import json
import subprocess
import cv2
import numpy as np
import requests
import RPi.GPIO as GPIO
import tflite_runtime.interpreter as tflite

# === ì„¼ì„œ í•€ ===
PIR_PIN = 17

# === ê²½ë¡œ ì„¤ì • ===
BASE_DIR = "/home/pi/security_project"
MODEL_PATH = os.path.join(BASE_DIR, "yolov8n.tflite")
RECORD_DIR = os.path.join(BASE_DIR, "recordings")
os.makedirs(RECORD_DIR, exist_ok=True)

# === ìœ„í—˜ í´ë˜ìŠ¤ ì •ì˜ ===
RISK_CLASSES = {"knife", "gun", "fire", "person"}  # personì€ ì˜ˆì‹œë¡œ í¬í•¨
# YOLOv8 COCO í´ë˜ìŠ¤ ì¼ë¶€ (í•„ìš”ì‹œ ì „ì²´ ëª©ë¡ ë„£ê¸°)
COCO_CLASSES = [
    "person", "bicycle", "car", "motorbike", "aeroplane", "bus", "train", "truck",
    "boat", "traffic light", "fire hydrant", "stop sign", "parking meter", "bench",
    "bird", "cat", "dog", "horse", "sheep", "cow", "elephant", "bear", "zebra",
    "giraffe", "backpack", "umbrella", "handbag", "tie", "suitcase", "frisbee",
    "skis", "snowboard", "sports ball", "kite", "baseball bat", "baseball glove",
    "skateboard", "surfboard", "tennis racket", "bottle", "wine glass", "cup", "fork",
    "knife", "spoon", "bowl", "banana", "apple", "sandwich", "orange", "broccoli",
    "carrot", "hot dog", "pizza", "donut", "cake", "chair", "sofa", "pottedplant",
    "bed", "diningtable", "toilet", "tvmonitor", "laptop", "mouse", "remote",
    "keyboard", "cell phone", "microwave", "oven", "toaster", "sink", "refrigerator",
    "book", "clock", "vase", "scissors", "teddy bear", "hair drier", "toothbrush"
]

# === Seafile ì„¤ì • ===
SEAFILE_UPLOAD_URL = "https://your-seafile-server.com/seafhttp/upload-api-url"
SEAFILE_TOKEN = "your-token"

# === GPIO ì„¤ì • ===
GPIO.setmode(GPIO.BCM)
GPIO.setup(PIR_PIN, GPIO.IN)

# === ë°ê¸° ê°ì§€ í•¨ìˆ˜ (LDR + ADC ì—†ì„ ê²½ìš° ë”ë¯¸ ì²˜ë¦¬) ===
def is_dark():
    return True  # ì‹¤ì œ ì¡°ë„ ì„¼ì„œ ì¶”ê°€ ì‹œ êµ¬í˜„

# === ì„¼ì„œ íŠ¸ë¦¬ê±° ì¡°ê±´ ===
def sensor_triggered():
    return GPIO.input(PIR_PIN) == GPIO.HIGH and is_dark()

# === ë…¹í™” ===
def record_video(path, duration=10):
    command = [
        'ffmpeg',
        '-y',
        '-f', 'v4l2', '-framerate', '20', '-video_size', '640x480', '-i', '/dev/video0',
        '-f', 'alsa', '-i', 'plughw:1',
        '-c:v', 'libx264', '-preset', 'ultrafast',
        '-c:a', 'aac',
        '-t', str(duration),
        path
    ]
    subprocess.run(command, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

# === TFLite YOLO ìœ„í—˜ ê°ì§€ ===
def detect_risk_tflite(video_path):
    interpreter = tflite.Interpreter(model_path=MODEL_PATH)
    interpreter.allocate_tensors()
    input_details = interpreter.get_input_details()
    output_details = interpreter.get_output_details()

    cap = cv2.VideoCapture(video_path)
    risk_detected = False

    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            break

        # ì „ì²˜ë¦¬: 640x640, normalize
        img = cv2.resize(frame, (640, 640))
        img = img / 255.0
        img = img.astype(np.float32)
        input_tensor = np.expand_dims(img, axis=0)

        interpreter.set_tensor(input_details[0]['index'], input_tensor)
        interpreter.invoke()

        output_data = interpreter.get_tensor(output_details[0]['index'])  # [1, N, 6]
        detections = output_data[0]

        for det in detections:
            conf = det[4]
            cls_id = int(det[5])
            if conf > 0.4:
                label = COCO_CLASSES[cls_id]
                print(f"ê°ì§€: {label} ({conf:.2f})")
                if label in RISK_CLASSES:
                    risk_detected = True
                    break
        if risk_detected:
            break
    cap.release()
    return risk_detected

# === Seafile ì—…ë¡œë“œ ===
def upload_to_seafile(file_path):
    headers = {'Authorization': f'Token {SEAFILE_TOKEN}'}
    files = {'file': open(file_path, 'rb')}
    data = {'parent_dir': '/'}
    response = requests.post(SEAFILE_UPLOAD_URL, headers=headers, data=data, files=files)
    return response.status_code == 200

# === ë©”ì¸ ë£¨í”„ ===
def main():
    print("âœ… ì‹œìŠ¤í…œ ì‹œì‘: ì„¼ì„œ ê°ì§€ ëŒ€ê¸° ì¤‘...")
    while True:
        if sensor_triggered():
            timestamp = time.strftime('%Y-%m-%d_%H-%M-%S')
            folder = os.path.join(RECORD_DIR, timestamp)
            os.makedirs(folder, exist_ok=True)

            video_path = os.path.join(folder, "video.mp4")
            flag_path = os.path.join(folder, "flag.json")

            print("ğŸ¬ ë…¹í™” ì¤‘...")
            record_video(video_path)

            print("ğŸ” ìœ„í—˜ ë¶„ì„ ì¤‘...")
            risk = detect_risk_tflite(video_path)

            if risk:
                with open(flag_path, 'w') as f:
                    json.dump({"timestamp": timestamp, "risk": True}, f)
                print("âš ï¸ ìœ„í—˜ í”Œë˜ê·¸ ì €ì¥ ì™„ë£Œ")

            print("â˜ï¸ Seafile ì—…ë¡œë“œ ì¤‘...")
            upload_to_seafile(video_path)
            if risk:
                upload_to_seafile(flag_path)

            print("âœ… ì²˜ë¦¬ ì™„ë£Œ. ëŒ€ê¸° ì¤‘...\n")
            time.sleep(3)
        else:
            time.sleep(1)

# === ì‹¤í–‰ ===
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        GPIO.cleanup()
        print("\nğŸ›‘ ì¢…ë£Œë¨.")
